services:
  wgs-pipeline:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_DATE: ${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        BUILD_VERSION: ${BUILD_VERSION:-latest}
        VCS_REF: ${VCS_REF:-$(git rev-parse --short HEAD)}
    image: wgs-pipeline:latest
    container_name: wgs-analysis

    # Resource limits (16GB optimized)
    deploy:
      resources:
        limits:
          memory: 16G
          cpus: '4'
        reservations:
          memory: 8G
          cpus: '2'

    # Environment variables
    environment:
      - WGS_PIPELINE_HOME=/opt/wgs-pipeline
      - PYTHONUNBUFFERED=1

    # Expected host volume layout:
    # ./data/raw                -> raw FASTQ input files
    # ./data/processed          -> cleaned FASTQ output
    # ./data/reference          -> reference FASTA + indexes (or set REFERENCE_DIR)
    # ./results                 -> BAM/VCF/annotation outputs
    # ./logs                    -> pipeline logs
    # ./temp                    -> temporary files
    volumes:
      - ./data/raw:/opt/wgs-pipeline/data/raw
      - ./data/processed:/opt/wgs-pipeline/data/processed
      - ${REFERENCE_DIR:-./data/reference}:/opt/wgs-pipeline/data/reference
      - ./results:/opt/wgs-pipeline/results
      - ./logs:/opt/wgs-pipeline/logs
      - ./temp:/opt/wgs-pipeline/temp
      - ${CONFIG_DIR:-./config}:/opt/wgs-pipeline/config:ro

    # Working directory
    working_dir: /opt/wgs-pipeline

    # Keep container running
    tty: true
    stdin_open: true

    # Custom command (optional)
    # Note: image ENTRYPOINT already runs commands inside conda env `wgs_analysis`
    command: ${DOCKER_CMD:-/bin/bash}

    # Networking
    network_mode: "host"

    # Restart policy
    restart: unless-stopped

  # Optional: Jupyter notebook service for interactive analysis
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile
    image: wgs-pipeline:latest
    container_name: wgs-jupyter

    depends_on:
      - wgs-pipeline

    # Jupyter-specific settings
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - JUPYTER_TOKEN=${JUPYTER_TOKEN:-wgs-analysis}

    # Ports for Jupyter
    ports:
      - "${JUPYTER_PORT:-8888}:8888"

    # Volume mounts (same data layout as main service)
    volumes:
      - ./data/raw:/opt/wgs-pipeline/data/raw
      - ./data/processed:/opt/wgs-pipeline/data/processed
      - ${REFERENCE_DIR:-./data/reference}:/opt/wgs-pipeline/data/reference
      - ./results:/opt/wgs-pipeline/results
      - ./logs:/opt/wgs-pipeline/logs
      - ./notebooks:/opt/wgs-pipeline/notebooks

    # Jupyter startup command
    command:
      - bash
      - -c
      - |
        pip install jupyterlab &&
        mkdir -p notebooks &&
        jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root

    # Only start if explicitly requested
    profiles:
      - jupyter
