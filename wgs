#!/usr/bin/env python3
"""
WGS Pipeline CLI Wrapper
Unified entry point for WGS analysis tools.
"""

import argparse
import subprocess
import sys
import os
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent.resolve() / "scripts"

def run_script(script_name, args, unknown_args):
    """Run a bash script with arguments"""
    script_path = SCRIPT_DIR / script_name
    if not script_path.exists():
        print(f"Error: Script {script_name} not found at {script_path}")
        sys.exit(1)
        
    cmd = [str(script_path)] + unknown_args
    
    # Map known python args to bash flags if needed, or just pass through
    # For now, we pass all unknown_args directly to the script
    
    print(f"üöÄ Running {script_name}...")
    try:
        subprocess.run(cmd, check=True)
    except subprocess.CalledProcessError as e:
        print(f"‚ùå {script_name} failed with exit code {e.returncode}")
        sys.exit(e.returncode)

def cmd_check(args, unknown_args):
    """Run system requirements check"""
    run_script("check_requirements.sh", args, unknown_args)

def cmd_run(args, unknown_args):
    """Run the full pipeline"""
    # The root run_pipeline.sh is in the repo root
    root_dir = SCRIPT_DIR.parent
    pipeline_script = root_dir / "run_pipeline.sh"
    
    if not pipeline_script.exists():
        print(f"Error: Pipeline script not found at {pipeline_script}")
        sys.exit(1)
        
    print(f"üß¨ Starting WGS Pipeline...")
    try:
        subprocess.run([str(pipeline_script)] + unknown_args, check=True)
    except subprocess.CalledProcessError as e:
        print(f"‚ùå Pipeline failed with exit code {e.returncode}")
        sys.exit(e.returncode)

def main():
    parser = argparse.ArgumentParser(description="WGS Analysis Pipeline CLI")
    subparsers = parser.add_subparsers(dest="command", help="Command to run")
    
    # Check command
    check_parser = subparsers.add_parser("check", help="Check system requirements")
    
    # Run command
    run_parser = subparsers.add_parser("run", help="Run the full pipeline")
    
    # QC command
    qc_parser = subparsers.add_parser("qc", help="Run quality control step only")
    
    # Parse known args, keep others for the scripts
    args, unknown = parser.parse_known_args()
    
    if args.command == "check":
        cmd_check(args, unknown)
    elif args.command == "run":
        cmd_run(args, unknown)
    elif args.command == "qc":
        run_script("quality_control.sh", args, unknown)
    else:
        parser.print_help()

if __name__ == "__main__":
    main()
